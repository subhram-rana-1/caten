<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Simplify SSE API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-section {
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .event {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: white;
        }
        .event.done {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .event.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .event-data {
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .status.connecting {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status.connected {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Simplify SSE API</h1>
        
        <div class="input-section">
            <h3>Test Data (JSON)</h3>
            <textarea id="testData" placeholder="Enter test data here...">[
  {
    "textStartIndex": 56,
    "textLength": 275,
    "text": "The serendipitous discovery of the ancient manuscript in the sepulchral chamber of the abandoned cathedral was nothing short of preternatural. Scholars were perplexed by its ineffable contents, which seemed to defy conventional epistemology.",
    "previousSimplifiedTexts": [
      "Finding the old manuscript in the tomb of the empty cathedral was an amazing surprise. Experts were confused by its mysterious contents, which seemed to challenge normal ways of understanding."
    ]
  },
  {
    "textStartIndex": 256,
    "textLength": 309,
    "text": "The palimpsest was so obfuscated by time that many feared the inextricable truth within it would remain hidden forever. The entire expedition was surrounded by an air of elusive mystery, as if the document itself held an inscrutable power over its seekers.",
    "previousSimplifiedTexts": [
      "The old document was so faded that people worried its secrets might never be found. The whole search felt mysterious, as if the document had a strange hold on those looking for it."
    ]
  }
]</textarea>
            <br><br>
            <button id="testBtn" onclick="testSSE()">Test SSE Endpoint</button>
            <button id="clearBtn" onclick="clearOutput()">Clear Output</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="output" id="output">
            <p>Click "Test SSE Endpoint" to start testing...</p>
        </div>
    </div>

    <script>
        let eventSource = null;
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        function addEvent(data, type = '') {
            const output = document.getElementById('output');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            eventDiv.innerHTML = `
                <strong>[${timestamp}] Event ${type ? `(${type})` : ''}</strong><br>
                <div class="event-data">${data}</div>
            `;
            
            output.appendChild(eventDiv);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('output').innerHTML = '<p>Output cleared. Click "Test SSE Endpoint" to start testing...</p>';
            hideStatus();
        }
        
        async function testSSE() {
            const testDataText = document.getElementById('testData').value;
            const testBtn = document.getElementById('testBtn');
            
            try {
                // Parse and validate JSON
                const testData = JSON.parse(testDataText);
                
                // Disable button and show status
                testBtn.disabled = true;
                showStatus('Connecting to SSE endpoint...', 'connecting');
                clearOutput();
                
                // Make POST request to get SSE stream
                const response = await fetch('/api/v2/simplify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                showStatus('Connected! Streaming data...', 'connected');
                
                // Read the stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        addEvent('Stream ended', 'done');
                        showStatus('Stream completed successfully!', 'connected');
                        break;
                    }
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer
                    
                    for (const line of lines) {
                        if (line.trim()) {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                if (data === '[DONE]') {
                                    addEvent('Stream completed', 'done');
                                } else {
                                    try {
                                        const parsedData = JSON.parse(data);
                                        addEvent(JSON.stringify(parsedData, null, 2));
                                    } catch (e) {
                                        addEvent(data);
                                    }
                                }
                            } else {
                                addEvent(line);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error:', error);
                addEvent(`Error: ${error.message}`, 'error');
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
